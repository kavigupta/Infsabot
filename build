#!/bin/bash
demo_board_size="100"

stdlog="___std.log"
errlog="___err.log"
errcolor="\e[0;31m"
logcolor="\e[0;32m"
succolor="\e[1;36m"
norcolor="\033[0m"

n=1
perform_commit=false
while [ "$n" -lt "$#" ]; do
    if [ "${!n}" == "-commit" ]; then
        perform_commit=true
        n=$((n+1))
        echo "${!n}"
        commit_msg=${!n}
    elif [ "${!n}" == "-keeplog"]; then
        keep_log=true
    else
        echo "Unrecognized command $@{!n}"
    fi
    n=$((n+1))
done


function echl {
    echo -e "$logcolor$1$norcolor"
}
function echs {
    echo -e "$succolor$1$norcolor"
}
function echf {
    echo -e "$errcolor$1$norcolor"
}

function perror_clean {
    echo -e "$errcolor"
    cat $errlog
    echo -e "$norcolor"
    exit 1
}

function runInterpreter {
    ghci "$1" -XTupleSections -Wall -Werror
}

for f in ./Infsabot/*.hs
do
    echl "Compiling $f"
    runInterpreter "$f" <<EOD >> $stdlog 2> $errlog
EOD
    errsize=$(wc -c <"$errlog")

    if [ "$errsize" != "0" ]; then
        echf "Haskell Files did not build correctly"
        perror_clean
    fi
done

echs "All Haskell Files Built"

runInterpreter "Infsabot/Main.hs" <<EOD >> $stdlog 2> $errlog
createDemoBoards $demo_board_size
EOD

errsize=$(wc -c <"$errlog")

if [ "$errsize" = "0" ] ; then
    echs "Image produced"
else
    echf "Image was not correctly produced"
    perror_clean
fi

rm ./Infsabot/*hi 2>> /dev/null
rm ./Infsabot/*.o 2>> /dev/null

if [ "$keep_log" == false ]; then
    rm "$errlog"
    rm "$stdlog"
fi

if [ "$perform_commit" == true ]; then
    echo -e "$logcolor"
    git add .
    git commit -m "$commit_msg"
    echo -e "$norcolor"
    echs "Changes Committed"
fi
